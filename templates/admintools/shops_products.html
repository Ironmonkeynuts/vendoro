{% extends "admintools/base.html" %}
{% block admintools_content %}

<h1 class="h4 mb-3">Shops & Products</h1>

{% if shops %}
  <div class="accordion" id="shopsAccordion">
    {% for s in shops %}
      <div class="accordion-item mb-2">
        <h2 class="accordion-header" id="shop-h-{{ s.id }}">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#shop-c-{{ s.id }}" aria-expanded="false" aria-controls="shop-c-{{ s.id }}">
            <div class="w-100 d-flex justify-content-between align-items-center">
              <div>
                <span class="fw-semibold">{{ s.name }}</span>
                <span class="text-muted small"> · @{{ s.owner.username }}</span>
              </div>
              <div class="d-flex gap-2 small">
                <span class="badge text-bg-secondary">Products: {{ s.product_count|default:0 }}</span>
                <span class="badge text-bg-secondary">Reviews: {{ s.total_reviews|default:0 }}</span>
                <span class="badge text-bg-secondary">Avg ★: {{ s.avg_rating|default:"—"|floatformat:2 }}</span>
                <span class="badge text-bg-secondary">Sold: {{ s.items_sold|default:0 }}</span>
                <span class="badge text-bg-secondary">Revenue: £{{ s.gross_revenue|default:"0.00"|floatformat:2 }}</span>
              </div>
            </div>
          </button>
        </h2>
        <div id="shop-c-{{ s.id }}" class="accordion-collapse collapse" aria-labelledby="shop-h-{{ s.id }}"
             data-bs-parent="#shopsAccordion">
          <div class="accordion-body">
            <div class="mb-3">
              <div class="fw-semibold">Owner</div>
              <div>{{ s.owner.get_full_name|default:s.owner.username }} — {{ s.owner.email }}</div>
            </div>

            {% if s.adm_products %}
              <div class="table-responsive">
                <table class="table align-middle">
                  <thead>
                    <tr class="text-muted small">
                      <th>Product</th>
                      <th>Category</th>
                      <th class="text-end">Price</th>
                      <th>Active</th>
                      <th>Created</th>
                      <th class="text-center">Reviews</th>
                      <th class="text-end">Sold</th>
                      <th class="text-end">Revenue</th>
                      <th class="text-end">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for p in s.adm_products %}
                      <tr>
                        <td>
                          <a href="{% url 'marketplace:product_detail' shop_slug=p.shop.slug product_slug=p.slug %}">
                            {{ p.title }}
                          </a>
                        </td>
                        <td>{{ p.category.name|default:"—" }}</td>
                        <td class="text-end">£{{ p.price|floatformat:2 }}</td>

                        {# Active status badge (read-only) #}
                        <td>
                          {% if p.is_active %}
                            <span class="badge text-bg-success">Yes</span>
                          {% else %}
                            <span class="badge text-bg-secondary">No</span>
                          {% endif %}
                        </td>

                        <td>{{ p.created_at|date:"Y-m-d" }}</td>
                        <td class="text-center">
                          {% if p.review_count %}
                            {{ p.review_avg|floatformat:1 }}/5 ({{ p.review_count }})
                          {% else %}
                            <span class="text-muted">—</span>
                          {% endif %}
                        </td>
                        <td class="text-end">{{ p.items_sold|default:0 }}</td>
                        <td class="text-end">£{{ p.revenue|default:"0.00"|floatformat:2 }}</td>

                        {# Actions: Suspend/Activate toggle + View #}
                        <td class="text-end">
                          <form method="post"
                                action="{% url 'admintools:product_toggle_suspend' pk=p.id %}"
                                class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="next" value="{{ request.get_full_path }}">
                            {% if p.is_active %}
                              <button class="btn btn-sm btn-outline-danger" title="Suspend this product">
                                Suspend
                              </button>
                            {% else %}
                              <button class="btn btn-sm btn-outline-success" title="Activate this product">
                                Activate
                              </button>
                            {% endif %}
                          </form>
                          <a class="btn btn-sm btn-outline-primary ms-1"
                             href="{% url 'marketplace:product_detail' shop_slug=p.shop.slug product_slug=p.slug %}">
                            View
                          </a>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="text-muted">No products in this shop.</p>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <p class="text-muted">No shops found.</p>
{% endif %}

{% endblock %}
