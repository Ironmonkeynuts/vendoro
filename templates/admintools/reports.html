{% extends "admintools/base.html" %}
{% load humanize %}

{% block extra_css %}
<style>
  .range-toolbar .btn { padding-top:.375rem; padding-bottom:.375rem; line-height:1.5; }
</style>
{% endblock %}

{% block admintools_content %}

<h1 class="h4 mb-3">Reports</h1>

<form method="get"
      class="range-toolbar d-flex flex-wrap flex-md-nowrap align-items-center gap-2 mb-3">

  <!-- LEFT: range, (conditional) start/end, apply -->
  <div class="d-flex flex-wrap align-items-center gap-2">
    <select name="range" id="rangeSelect" class="form-select w-auto">
      <option value="7"  {% if range.label == "7" %}selected{% endif %}>Last 7 days</option>
      <option value="30" {% if range.label == "30" %}selected{% endif %}>Last 30 days</option>
      <option value="90" {% if range.label == "90" %}selected{% endif %}>Last 90 days</option>
      <option value="custom" {% if range.label == "custom" %}selected{% endif %}>Custom</option>
    </select>

    <div id="customDates"
         class="d-flex align-items-center gap-2 {% if range.label != 'custom' %}d-none{% endif %}">
      <input type="date" name="start" value="{{ range.start|date:'Y-m-d' }}"
             class="form-control w-auto" style="width: 10.5rem;">
      <input type="date" name="end" value="{{ range.end|date:'Y-m-d' }}"
             class="form-control w-auto" style="width: 10.5rem;">
    </div>

    <button class="btn btn-primary" type="submit">Apply</button>
  </div>

  <!-- RIGHT: CSV buttons -->
  <div class="ms-auto d-flex align-items-center gap-2">
    <a class="btn btn-outline-secondary text-nowrap"
       href="{% url 'admintools:reports_export_csv' %}?range={{ range.label }}&start={{ range.start|date:'Y-m-d' }}&end={{ range.end|date:'Y-m-d' }}">
      Export Daily CSV
    </a>

    <a class="btn btn-outline-secondary text-nowrap"
       href="{% url 'admintools:reports_export_products_csv' %}?range={{ range.label }}&start={{ range.start|date:'Y-m-d' }}&end={{ range.end|date:'Y-m-d' }}">
      Export Product CSV
    </a>
  </div>
</form>

{# KPI CARDS #}
<div class="row g-3 mb-4">
  <div class="col-lg-4">
    <div class="card h-100">
      <div class="card-body">
        <div class="h6 text-muted mb-2">Users</div>
        <div class="d-flex flex-wrap gap-3">
          <div><div class="fw-semibold">{{ kpi.users.total|intcomma }}</div><div class="text-muted small">Total</div></div>
          <div><div class="fw-semibold">{{ kpi.users.active|intcomma }}</div><div class="text-muted small">Active</div></div>
          <div><div class="fw-semibold">{{ kpi.users.suspended|intcomma }}</div><div class="text-muted small">Suspended</div></div>
          <div><div class="fw-semibold">{{ kpi.users.staff|intcomma }}</div><div class="text-muted small">Staff</div></div>
          <div><div class="fw-semibold">{{ kpi.users.superusers|intcomma }}</div><div class="text-muted small">Superusers</div></div>
        </div>
        <hr>
        <div class="small">New in range: <span class="fw-semibold">{{ kpi.users.new_range|intcomma }}</span></div>
        <div class="small text-muted">7d: {{ kpi.users.new_7d|intcomma }} · 30d: {{ kpi.users.new_30d|intcomma }} · 1y: {{ kpi.users.new_1y|intcomma }}</div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card h-100">
      <div class="card-body">
        <div class="h6 text-muted mb-2">Catalog</div>
        <div class="d-flex flex-wrap gap-3">
          <div><div class="fw-semibold">{{ kpi.catalog.shops|intcomma }}</div><div class="text-muted small">Shops</div></div>
          <div><div class="fw-semibold">{{ kpi.catalog.products|intcomma }}</div><div class="text-muted small">Products</div></div>
          <div><div class="fw-semibold">{{ kpi.catalog.active_products|intcomma }}</div><div class="text-muted small">Active</div></div>
          <div><div class="fw-semibold">{{ kpi.catalog.inactive_products|intcomma }}</div><div class="text-muted small">Inactive</div></div>
        </div>
        <hr>
        <div class="small">Reviews in range: <span class="fw-semibold">{{ kpi.catalog.reviews_range|intcomma }}</span></div>
        <div class="small text-muted">7d: {{ kpi.catalog.reviews_7d|intcomma }} · 30d: {{ kpi.catalog.reviews_30d|intcomma }} · 1y: {{ kpi.catalog.reviews_1y|intcomma }}</div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card h-100">
      <div class="card-body">
        <div class="h6 text-muted mb-2">Sales</div>
        <div class="d-flex flex-wrap gap-3">
          <div><div class="fw-semibold">{{ kpi.sales.orders|intcomma }}</div><div class="text-muted small">Total Orders</div></div>
          <div><div class="fw-semibold">£{{ kpi.sales.gross_revenue|floatformat:2 }}</div><div class="text-muted small">Gross Revenue</div></div>
        </div>
        <hr>
        <div class="small">In range: <span class="fw-semibold">{{ kpi.sales.orders_range|intcomma }}</span> orders · <span class="fw-semibold">£{{ kpi.sales.revenue_range|floatformat:2 }}</span></div>
        <div class="small text-muted">7d: £{{ kpi.sales.revenue_7d|floatformat:2 }} · 30d: £{{ kpi.sales.revenue_30d|floatformat:2 }} · 1y: £{{ kpi.sales.revenue_1y|floatformat:2 }}</div>
      </div>
    </div>
  </div>
</div>

{# LEADERS #}
<div class="row g-3 mb-4">
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-body">
        <div class="h6 mb-3">Top Products ({{ range.start|date:"Y-m-d" }} → {{ range.end|date:"Y-m-d" }})</div>
        <div class="table-responsive">
          <table class="table align-middle">
            <thead class="small text-muted">
              <tr>
                <th>Product</th>
                <th class="text-end">Orders</th>
                <th class="text-end">Items</th>
                <th class="text-end">Revenue</th>
              </tr>
            </thead>
            <tbody>
              {% for p in leaders.products %}
                <tr>
                  <td>
                    <div class="fw-semibold">{{ p.product__title }}</div>
                    <div class="small text-muted">{{ p.product__shop__name }}</div>
                  </td>
                  <td class="text-end">{{ p.orders|intcomma }}</td>
                  <td class="text-end">{{ p.items_sold|intcomma }}</td>
                  <td class="text-end">£{{ p.revenue|floatformat:2 }}</td>
                </tr>
              {% empty %}
                <tr><td colspan="4" class="text-muted">No product sales in this range.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-body">
        <div class="h6 mb-3">Top Shops ({{ range.start|date:"Y-m-d" }} → {{ range.end|date:"Y-m-d" }})</div>
        <div class="table-responsive">
          <table class="table align-middle">
            <thead class="small text-muted">
              <tr>
                <th>Shop</th>
                <th class="text-end">Orders</th>
                <th class="text-end">Items</th>
                <th class="text-end">Revenue</th>
              </tr>
            </thead>
            <tbody>
              {% for s in leaders.shops %}
                <tr>
                  <td>
                    <div class="fw-semibold">{{ s.product__shop__name }}</div>
                    <div class="small text-muted">@{{ s.product__shop__owner__username }}</div>
                  </td>
                  <td class="text-end">{{ s.orders|intcomma }}</td>
                  <td class="text-end">{{ s.items_sold|intcomma }}</td>
                  <td class="text-end">£{{ s.revenue|floatformat:2 }}</td>
                </tr>
              {% empty %}
                <tr><td colspan="4" class="text-muted">No shop sales in this range.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

{# STEP 4 — RECENT ACTIVITY #}
<div class="card mb-4">
  <div class="card-body">
    <div class="h6 mb-3">Recent Activity ({{ range.start|date:"Y-m-d" }} → {{ range.end|date:"Y-m-d" }})</div>

    <div class="accordion" id="activityAcc">
      <div class="accordion-item">
        <h2 class="accordion-header" id="acc-orders-h">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#acc-orders-c" aria-expanded="true" aria-controls="acc-orders-c">
            Latest Paid Orders
          </button>
        </h2>
        <div id="acc-orders-c" class="accordion-collapse collapse show" aria-labelledby="acc-orders-h" data-bs-parent="#activityAcc">
          <div class="accordion-body">
            <div class="table-responsive">
              <table class="table align-middle">
                <thead class="small text-muted">
                  <tr>
                    <th>When</th>
                    <th>Buyer</th>
                    <th class="text-end">Items</th>
                    <th class="text-end">Total</th>
                  </tr>
                </thead>
                <tbody>
                  {% for o in activity.orders %}
                    <tr>
                      <td class="small text-muted">{{ o.created_at|date:"Y-m-d H:i" }}</td>
                      <td>
                        {% if o.user %}
                          <div class="fw-semibold">{{ o.user.get_full_name|default:o.user.username }}</div>
                          <div class="small text-muted">@{{ o.user.username }}</div>
                        {% else %}
                          <span class="text-muted">—</span>
                        {% endif %}
                      </td>
                      <td class="text-end">{{ o.items_count_calc|intcomma }}</td>
                      <td class="text-end">£{{ o.total_amount_calc|floatformat:2 }}</td>
                    </tr>
                  {% empty %}
                    <tr><td colspan="4" class="text-muted">No paid orders in this range.</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="accordion-item">
        <h2 class="accordion-header" id="acc-reviews-h">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#acc-reviews-c" aria-expanded="false" aria-controls="acc-reviews-c">
            Latest Reviews
          </button>
        </h2>
        <div id="acc-reviews-c" class="accordion-collapse collapse" aria-labelledby="acc-reviews-h" data-bs-parent="#activityAcc">
          <div class="accordion-body">
            <div class="table-responsive">
              <table class="table align-middle">
                <thead class="small text-muted">
                  <tr>
                    <th>When</th>
                    <th>User</th>
                    <th>Product</th>
                    <th>Rating</th>
                    <th>Comment</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in activity.reviews %}
                    <tr>
                      <td class="small text-muted">{{ r.created_at|date:"Y-m-d H:i" }}</td>
                      <td>
                        {% if r.user %}
                          <div class="fw-semibold">{{ r.user.get_full_name|default:r.user.username }}</div>
                          <div class="small text-muted">@{{ r.user.username }}</div>
                        {% else %}
                          <span class="text-muted">—</span>
                        {% endif %}
                      </td>
                      <td>
                        <div class="fw-semibold">{{ r.product.title }}</div>
                        <div class="small text-muted">{{ r.product.shop.name }}</div>
                      </td>
                      <td>{{ r.rating }}/5</td>
                      <td class="small text-muted">{{ r.comment|truncatechars:80 }}</td>
                    </tr>
                  {% empty %}
                    <tr><td colspan="5" class="text-muted">No reviews in this range.</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="accordion-item">
        <h2 class="accordion-header" id="acc-signups-h">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#acc-signups-c" aria-expanded="false" aria-controls="acc-signups-c">
            Latest Signups
          </button>
        </h2>
        <div id="acc-signups-c" class="accordion-collapse collapse" aria-labelledby="acc-signups-h" data-bs-parent="#activityAcc">
          <div class="accordion-body">
            <div class="table-responsive">
              <table class="table align-middle">
                <thead class="small text-muted">
                  <tr>
                    <th>When</th>
                    <th>User</th>
                    <th>Email</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for u in activity.signups %}
                    <tr>
                      <td class="small text-muted">{{ u.date_joined|date:"Y-m-d H:i" }}</td>
                      <td>
                        <div class="fw-semibold">{{ u.get_full_name|default:u.username }}</div>
                        <div class="small text-muted">@{{ u.username }}</div>
                      </td>
                      <td class="small">{{ u.email }}</td>
                      <td>
                        {% if u.is_active %}
                          <span class="badge text-bg-success">Active</span>
                        {% else %}
                          <span class="badge text-bg-secondary">Inactive</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% empty %}
                    <tr><td colspan="4" class="text-muted">No signups in this range.</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div> {# /accordion #}
  </div>
</div>

<script>
  (function () {
    const range = document.getElementById('rangeSelect');
    const dates = document.getElementById('customDates');
    if (!range || !dates) return;

    function toggleDates() {
      if (range.value === 'custom') {
        dates.classList.remove('d-none');
      } else {
        dates.classList.add('d-none');
      }
    }
    range.addEventListener('change', toggleDates);
    // ensure correct initial state if turbo/htmx/partial loads
    toggleDates();
  })();
</script>

{% endblock %}
