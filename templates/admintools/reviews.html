{% extends "admintools/base.html" %}
{% load static %}
{% block admintools_content %}

<h1 class="h4 mb-3">Reviews</h1>

<form method="get" class="row g-2 align-items-end mb-3">
  <div class="col-md-4">
    <label class="form-label small text-muted">Search</label>
    <input type="text" name="q" value="{{ q }}" class="form-control"
           placeholder="Text, product, shop, user">
  </div>

  <div class="col-md-2 col-6">
    <label class="form-label small text-muted">Rating</label>
    <select name="rating" class="form-select">
      <option value="">All</option>
      {% for r in "12345" %}
        <option value="{{ r }}" {% if rating == r %}selected{% endif %}>{{ r }}★</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-2 col-6">
    <label class="form-label small text-muted">Visibility</label>
    <select name="vis" class="form-select">
      <option value="all" {% if vis == "all" %}selected{% endif %}>All</option>
      <option value="public" {% if vis == "public" %}selected{% endif %}>Public</option>
      <option value="hidden" {% if vis == "hidden" %}selected{% endif %}>Hidden</option>
    </select>
  </div>

  <div class="col-md-2 col-6">
    <label class="form-label small text-muted">Range</label>
    <select id="range" name="range" class="form-select">
      <option value="" {% if not range %}selected{% endif %}>Any time</option>
      <option value="7" {% if range == "7" %}selected{% endif %}>Last 7 days</option>
      <option value="30" {% if range == "30" %}selected{% endif %}>Last 30 days</option>
      <option value="90" {% if range == "90" %}selected{% endif %}>Last 90 days</option>
      <option value="custom" {% if range == "custom" %}selected{% endif %}>Custom</option>
    </select>
  </div>

  <div id="custom-range" class="col-md-2 col-6 {% if range != 'custom' %}d-none{% endif %}">
    <label class="form-label small text-muted">Start</label>
    <input type="date" name="start" value="{{ start }}" class="form-control">
  </div>
  <div id="custom-range-2" class="col-md-2 col-6 {% if range != 'custom' %}d-none{% endif %}">
    <label class="form-label small text-muted">End</label>
    <input type="date" name="end" value="{{ end }}" class="form-control">
  </div>

  <div class="col-md-auto">
    <button class="btn btn-primary px-3">Apply</button>
    <a class="btn btn-outline-secondary ms-1" href="{% url 'admintools:reviews' %}">Reset</a>
  </div>
</form>

{# Bulk form (separate; not wrapping the table) #}
<form id="bulk-form" method="post" action="{% url 'admintools:review_bulk_action' %}" class="mb-2">
  {% csrf_token %}
  <input type="hidden" name="next" value="{{ request.get_full_path }}">
  <div class="d-flex align-items-center gap-2 flex-wrap">
    <label class="me-1 small text-muted">Bulk actions:</label>
    <select name="action" class="form-select form-select-sm" style="width:auto; min-width:160px;">
      <option value="hide">Hide selected</option>
      <option value="show">Show selected</option>
      <option value="export_csv">Export selected (CSV)</option>
    </select>
    <button class="btn btn-sm btn-primary">Apply</button>
    <span id="sel-count" class="badge text-bg-secondary ms-1">0</span>
  </div>
</form>

<div class="table-responsive">
  <table class="table align-middle">
    <thead>
      <tr class="text-muted small">
        <th style="width:32px;"><input type="checkbox" id="check-all"></th>
        <th>Review</th>
        <th>Rating</th>
        <th>Product</th>
        <th>Shop</th>
        <th>User</th>
        <th>Visible</th>
        <th>Created</th>
        <th class="text-end">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for r in page_obj %}
        <tr>
          <td>
            {# Associate with bulk form without nesting #}
            <input type="checkbox" class="row-check" name="ids" value="{{ r.id }}" form="bulk-form">
          </td>
          <td class="text-break" style="max-width:380px;">
            {{ r.comment|default:"—" }}
          </td>
          <td>
            {% if r.rating %}{{ r.rating }}/5{% else %}<span class="text-muted">—</span>{% endif %}
          </td>
          <td>
            {% if r.product %}
              <a href="{% url 'marketplace:product_detail' shop_slug=r.product.shop.slug product_slug=r.product.slug %}">
                {{ r.product.title }}
              </a>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </td>
          <td>
            {% if r.product and r.product.shop %}
              {{ r.product.shop.name }}
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </td>
          <td>
            {% if r.user %}@{{ r.user.username }}{% else %}<span class="text-muted">—</span>{% endif %}
          </td>
          <td class="text-center">
            {% if r.is_public %}
              <span class="badge text-bg-success">Yes</span>
            {% else %}
              <span class="badge text-bg-secondary">No</span>
            {% endif %}
          </td>
          <td class="small text-muted">{{ r.created_at|date:"Y-m-d H:i" }}</td>
          <td class="text-end">
            <form method="post" action="{% url 'admintools:review_toggle_visibility' pk=r.id %}">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              {% if r.is_public %}
                <button class="btn btn-sm btn-outline-danger">Hide</button>
              {% else %}
                <button class="btn btn-sm btn-outline-success">Show</button>
              {% endif %}
            </form>
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="9" class="text-muted">No reviews found.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<nav aria-label="Pagination">
  <ul class="pagination">
    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?{{ request.GET.urlencode }}&page={{ page_obj.previous_page_number }}">Prev</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Prev</span></li>
    {% endif %}

    <li class="page-item disabled">
      <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
    </li>

    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?{{ request.GET.urlencode }}&page={{ page_obj.next_page_number }}">Next</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Next</span></li>
    {% endif %}
  </ul>
</nav>

<script>
  (function () {
    const rangeSel = document.getElementById('range');
    const c1 = document.getElementById('custom-range');
    const c2 = document.getElementById('custom-range-2');
    function sync() {
      const show = rangeSel.value === 'custom';
      c1.classList.toggle('d-none', !show);
      c2.classList.toggle('d-none', !show);
    }
    rangeSel.addEventListener('change', sync);
    sync();
  }());
</script>

<script>
  // Select all + counter
  (function () {
    const checkAll = document.getElementById('check-all');
    const rows = document.querySelectorAll('.row-check');
    const badge = document.getElementById('sel-count');

    function refresh() {
      let n = 0;
      rows.forEach(cb => { if (cb.checked) n++; });
      if (badge) badge.textContent = n;
      if (checkAll) {
        checkAll.indeterminate = (n > 0 && n < rows.length);
        checkAll.checked = (n === rows.length && rows.length > 0);
      }
    }

    if (checkAll) {
      checkAll.addEventListener('change', function () {
        rows.forEach(cb => { cb.checked = checkAll.checked; });
        refresh();
      });
    }
    rows.forEach(cb => cb.addEventListener('change', refresh));
    refresh();
  })();
</script>

{% endblock %}
