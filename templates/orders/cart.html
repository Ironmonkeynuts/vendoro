{% extends "base.html" %}
{% block content %}
<h2>Your Cart</h2>
{% if items %}
<table class="table align-middle">
  <thead><tr><th>Product</th><th style="width:120px">Qty</th><th>Price</th><th>Subtotal</th><th></th></tr></thead>
  <tbody>
  {% for item in items %}
    <tr data-item-id="{{ item.id }}">
      <td>{{ item.product.title }}</td>
      <td>
        <input class="form-control qty" type="number" min="1" value="{{ item.quantity }}">
      </td>
      <td>£{{ item.product.price }}</td>
      <td class="subtotal">£{{ item.subtotal }}</td>
      <td>
        <button class="btn btn-sm btn-outline-danger remove">Remove</button>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
<form class="d-inline" method="post" action="{% url 'orders:clear_cart' %}">{% csrf_token %}
  <button class="btn btn-outline-secondary">Empty cart</button>
</form>
<h4>Total: £<span id="cart-total">{{ total }}</span></h4>
<a class="btn btn-primary" href="#" disabled>Checkout</a>
{% else %}
<p>Your cart is empty.</p>
{% endif %}

<script>
// CSRF helper (reads cookie)
function getCookie(name){const v=document.cookie.match('(^|;)\s*'+name+'\s*=\s*([^;]+)');return v? v.pop():''}
const csrftoken = getCookie('csrftoken');

// Quantity change
for (const input of document.querySelectorAll('.qty')){
  input.addEventListener('change', async (e)=>{
    const tr = e.target.closest('tr');
    const id = tr.dataset.itemId;
    const form = new FormData();
    form.append('quantity', e.target.value);
    const resp = await fetch('{% url "orders:update_quantity" item_id=0 %}'.replace('0', id),{
      method:'POST', headers:{'X-CSRFToken': csrftoken, 'X-Requested-With':'XMLHttpRequest'}, body: form
    });
    if(!resp.ok){ alert('Update failed'); return; }
    const data = await resp.json();
    tr.querySelector('.subtotal').textContent = '£' + data.subtotal.toFixed(2);
    document.querySelector('#cart-total').textContent = data.total.toFixed(2);
  });
}

// Remove item
for (const btn of document.querySelectorAll('.remove')){
  btn.addEventListener('click', async (e)=>{
    const tr = e.target.closest('tr');
    const id = tr.dataset.itemId;
    const resp = await fetch('{% url "orders:remove_item" item_id=0 %}'.replace('0', id),{
      method:'POST', headers:{'X-CSRFToken': csrftoken, 'X-Requested-With':'XMLHttpRequest'}
    });
    if(!resp.ok){ alert('Remove failed'); return; }
    const data = await resp.json();
    tr.remove();
    const totalEl = document.querySelector('#cart-total');
    if (totalEl) totalEl.textContent = data.total.toFixed(2);
    if (document.querySelectorAll('tbody tr').length === 0){ location.reload(); }
  });
}
</script>
{% endblock %}