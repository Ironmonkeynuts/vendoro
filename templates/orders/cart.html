{% extends "base.html" %}
{% block content %}
<h2>Your Cart</h2>
{% if items %}
<div class="table-responsive">
  <table class="table align-middle cart-table">
    <thead>
      <tr>
        <th>Product</th>
        <th style="width:120px">Qty</th>
        <th>Price</th>
        <th>Subtotal</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
    {% for item in items %}
      <tr data-item-id="{{ item.id }}">
        <td>{{ item.product.title }}</td>
        <td class="text-center">
          <input class="form-control form-control-sm qty text-center"
                 type="number" min="1" value="{{ item.quantity }}"
                 data-current="{{ item.quantity }}"
                 {% if item.product.inventory and item.product.inventory.quantity > 0 %}
                   max="{{ item.product.inventory.quantity }}"
                 {% endif %}
                 inputmode="numeric">
        </td>
        <td>£{{ item.product.price }}</td>
        <td class="subtotal">£{{ item.subtotal }}</td>
        <td>
          <button class="btn btn-sm btn-outline-danger remove">Remove</button>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
<form class="d-inline" method="post" action="{% url 'orders:clear_cart' %}">{% csrf_token %}
  <button class="btn btn-outline-secondary">Empty cart</button>
</form>
<h4>Total: £<span id="cart-total">{{ total }}</span></h4>
<form method="post" action="{% url 'payments:create_checkout_session' %}" class="d-inline">
  {% csrf_token %}
  <button class="btn btn-primary">Checkout</button>
</form>
{% else %}
<p>Your cart is empty.</p>
{% endif %}

<script>
/* jshint esversion: 11 */

// CSRF helper (reads cookie)
function getCookie(name) {
  const match = document.cookie.match(
    '(^|;)\\s*' + name + '\\s*=\\s*([^;]+)'
  );
  return match ? match.pop() : '';
}

const csrftoken = getCookie('csrftoken');

// Quantity change
for (const input of document.querySelectorAll('.qty')) {
  input.addEventListener('change', async (e) => {
    const tr = e.target.closest('tr');
    const id = tr.dataset.itemId;
    const previous = e.target.dataset.current || e.target.value;
    const form = new FormData();
    form.append('quantity', e.target.value);

    const resp = await fetch(
      '{% url "orders:update_quantity" item_id=0 %}'.replace('0', id),
      {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: form
      }
    );

    const data = await resp.json().catch(() => null);

    if (!resp.ok || !data || data.ok === false) {
      const message = (data && data.error) ? data.error : 'Update failed';
      alert(message);
      const reset = (data && typeof data.qty !== 'undefined')
        ? data.qty
        : previous;
      e.target.value = reset;
      e.target.dataset.current = reset;
      return;
    }

    e.target.value = data.qty;
    e.target.dataset.current = data.qty;
    tr.querySelector('.subtotal').textContent =
      '£' + data.subtotal.toFixed(2);
    document.querySelector('#cart-total').textContent =
      data.total.toFixed(2);
    if (data.warning) {
      alert(data.warning);
    }
  });
}

// Remove item
for (const btn of document.querySelectorAll('.remove')) {
  btn.addEventListener('click', async (e) => {
    const tr = e.target.closest('tr');
    const id = tr.dataset.itemId;

    const resp = await fetch(
      '{% url "orders:remove_item" item_id=0 %}'.replace('0', id),
      {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest'
        }
      }
    );

    if (!resp.ok) {
      alert('Remove failed');
      return;
    }

    const data = await resp.json();
    tr.remove();

    const totalEl = document.querySelector('#cart-total');
    if (totalEl) {
      totalEl.textContent = data.total.toFixed(2);
    }

    if (document.querySelectorAll('tbody tr').length === 0) {
      location.reload();
    }
  });
}
</script>
{% endblock %}
