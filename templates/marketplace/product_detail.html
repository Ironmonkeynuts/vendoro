{% extends "base.html" %}
{% load cloudinary %}

{% block content %}
<div class="row g-4">
  <div class="col-md-8">
    <h1 class="h4 mb-3">{{ product.title }}</h1>
    {# Average + count #}
    {% if rating_count %}
      <p class="mb-1">
        <strong>{{ rating_avg|floatformat:1 }}/5</strong>
        <span class="text-muted">({{ rating_count }} review{{ rating_count|pluralize }})</span>
      </p>
    {% endif %}
    {# Main image + thumbs #}
    {% with images=product.images.all %}
      {% if images %}
        {% with lead=images.0 %}
          <div class="mb-3">
            {% cloudinary lead.image width=900 height=900 crop="fill" gravity="auto" fetch_format="auto" quality="auto" alt=lead.alt_text class="img-fluid rounded" %}
          </div>
        {% endwith %}
        {% if images|length > 1 %}
          <div class="d-flex flex-wrap gap-2">
            {% for pi in images %}
              <a href="{% url 'marketplace:product_detail' product.shop.slug product.slug %}#"
                 onclick="event.preventDefault(); document.getElementById('lead-img-{{ forloop.counter }}')?.scrollIntoView({behavior:'smooth'});">
                {% cloudinary pi.image width=140 height=140 crop="fill" gravity="auto" fetch_format="auto" quality="auto" alt=pi.alt_text class="img-thumbnail" %}
              </a>
            {% endfor %}
          </div>
        {% endif %}
      {% else %}
        <div class="bg-secondary bg-opacity-10 border rounded d-flex align-items-center justify-content-center" style="height: 420px;">
          <span class="text-muted">No image yet</span>
        </div>
      {% endif %}
    {% endwith %}

    <p class="lead mt-4">£{{ product.price|floatformat:2 }}</p>
    {% if product.description %}
      <p>{{ product.description }}</p>
    {% endif %}
  </div>

  <div class="col-md-4">
    <div class="card mb-3">
      <div class="card-body">
        <h6 class="text-uppercase text-muted mb-2">Sold by</h6>
        <a href="{% url 'marketplace:shop_detail' slug=product.shop.slug %}">{{ product.shop.name }}</a>
      </div>
    </div>

    {# Add to cart #}
    <div class="card">
      <div class="card-body">
        <form method="post" action="{% url 'orders:add_to_cart' product_id=product.id %}">
          {% csrf_token %}
          <div class="input-group" style="max-width: 260px;">
            <input type="number" name="quantity" class="form-control" min="1" value="1" required>
            <button class="btn btn-success" type="submit">Add to cart</button>
          </div>
        </form>
        {% if product.inventory %}
          {% if product.inventory.is_in_stock %}
            <small class="text-success d-block mt-2">In stock ({{ product.inventory.quantity }})</small>
          {% else %}
            <small class="text-danger d-block mt-2">Out of stock</small>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
</div>
{# CTA #}
{% if user.is_authenticated %}
  {% if already_reviewed %}
    <p class="text-muted small mb-3">You’ve already reviewed this product.</p>
  {% else %}
    <a class="btn btn-sm btn-primary mb-3"
       href="{% url 'marketplace:review_add' product.shop.slug product.slug %}">
       Write a review
    </a>
  {% endif %}
{% else %}
  <p class="small mb-3">
    <a href="{% url 'account_login' %}?next={{ request.path }}">Sign in</a> to write a review.
  </p>
{% endif %}
{# List reviews #}
{% if reviews %}
  <div class="vstack gap-3">
    {% for r in reviews %}
      <div class="border rounded p-3">
        <div class="d-flex justify-content-between">
          <strong>{{ r.user.username }}</strong>
          <span class="text-muted small">{{ r.created_at|date:"M j, Y" }}</span>
        </div>
        <div class="mb-1">Rating: {{ r.rating }} / 5</div>
        {% if r.comment %}
          <p class="mb-0">{{ r.comment }}</p>
        {% endif %}
      </div>
    {% endfor %}
  </div>
{% else %}
  <p class="text-muted">No reviews yet.</p>
{% endif %}
{% endblock %}