{% extends "base.html" %}
{% load cloudinary %}

{% block content %}
<div class="container py-3" style="max-width: 880px;">
  <h1 class="h4 mb-3">Manage Images â€” {{ product.title }}</h1>

  <button id="btn-upload" class="btn btn-outline-primary">Add Images</button>

  <hr class="my-4"/>

  <div class="row g-3">
    {% for pi in product.images.all %}
      <div class="col-6 col-md-3 text-center">
        {% cloudinary pi.image width=300 height=300 crop="fill" gravity="auto" fetch_format="auto" quality="auto" alt=pi.alt_text %}
        <div class="small text-muted mt-1">{{ pi.alt_text|default:"" }}</div>
      </div>
    {% empty %}
      <div class="col-12"><em>No images yet.</em></div>
    {% endfor %}
  </div>
</div>

<script>
/* jshint esversion: 11 */
/* global cloudinary, fetch */
document.addEventListener('DOMContentLoaded', function () {
  // Configuration from context processor (no secrets)
  var cloudName = "{{ CLOUDINARY_CLOUD_NAME }}";
  var apiKey = "{{ CLOUDINARY_API_KEY }}";

  // Endpoints
  var signUrl = "{% url 'marketplace:cloudinary_sign' %}";
  var attachUrl = "{% url 'marketplace:product_image_attach' product.id %}";

  function getCookie(name) {
    var match = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return match ? match.pop() : '';
  }

  var btn = document.getElementById('btn-upload');
  if (!btn) {
    return;
  }
  if (!window.cloudinary || !cloudinary.createUploadWidget) {
    return;
  }

  var widget = cloudinary.createUploadWidget({
    cloudName: cloudName,
    apiKey: apiKey,
    uploadSignature: function (callback, paramsToSign) {
      try {
        var qs = new URLSearchParams(paramsToSign);
        var url = signUrl + '?' + qs.toString();

        fetch(url, { credentials: 'same-origin' })
          .then(function (res) {
            return res.json();
          })
          .then(function (data) {
            if (data && data.signature) {
              callback(data.signature);
            } else {
              callback('');
            }
          })
          .catch(function () {
            callback('');
          });
      } catch (e) {
        callback('');
      }
    },
    folder: 'vendoro/product_images',
    sources: ['local', 'url', 'camera'],
    multiple: true,
    clientAllowedFormats: ['png', 'jpg', 'jpeg', 'webp'],
    maxFileSize: 5000000 // 5 MB
  }, function (error, result) {
    if (!error && result && result.event === 'success') {
      var info = result.info;
      var payload = {
        public_id: info.public_id,
        alt_text: info.original_filename || ''
      };

      fetch(attachUrl, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      })
        .then(function () {
          window.location.reload();
        })
        .catch(function () {
          window.location.reload();
        });
    }
  });

  btn.addEventListener('click', function () {
    widget.open();
  });
});
</script>
{% endblock %}
