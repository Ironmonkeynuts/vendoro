{% extends "base.html" %}
{% load cloudinary %}

{% block content %}
<div class="container py-3" style="max-width: 980px;">
  <h1 class="h4 mb-3">Edit Product â€” {{ product.title }}</h1>

  <form method="post" class="mb-4">
    {% csrf_token %}
    {{ form.as_p }}
    <button class="btn btn-primary">Save</button>
    <a class="btn btn-outline-secondary" href="{% url 'marketplace:product_detail' product.shop.slug product.slug %}">View</a>
  </form>

  <hr class="my-4"/>

  <div class="d-flex justify-content-between align-items-center mb-2">
    <h2 class="h5 m-0">Images</h2>
    <button id="btn-upload" class="btn btn-outline-primary" type="button">Add Images</button>
  </div>

  <div class="row g-3">
    {% for pi in product.images.all %}
      <div class="col-6 col-md-3 text-center">
        {% cloudinary pi.image width=300 height=300 crop="fill" gravity="auto" fetch_format="auto" quality="auto" alt=pi.alt_text %}
        <div class="small text-muted mt-1">{{ pi.alt_text|default:"" }}</div>
      </div>
    {% empty %}
      <div class="col-12"><em>No images yet.</em></div>
    {% endfor %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  function getCookie(name){
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }

  const signUrl = "{% url 'marketplace:cloudinary_sign' %}";
  const attachUrl = "{% url 'marketplace:product_image_attach' product.id %}";

  // Cloudinary config check
  const CLOUD_NAME = "{{ CLOUDINARY_CLOUD_NAME|default:''|escapejs }}";
  const API_KEY    = "{{ CLOUDINARY_API_KEY|default:''|escapejs }}";
  if (!CLOUD_NAME) console.error('Missing CLOUDINARY_CLOUD_NAME');
  if (!API_KEY)    console.error('Missing CLOUDINARY_API_KEY');

  const widget = cloudinary.createUploadWidget({
    cloudName: "{{ CLOUDINARY_CLOUD_NAME }}",
    apiKey: "{{ CLOUDINARY_API_KEY }}",
    uploadSignature: async (cb, paramsToSign) => {
      const url = signUrl + "?" + new URLSearchParams(paramsToSign).toString();
      const res = await fetch(url, { credentials: "same-origin" });
      if (!res.ok) {
        console.error("Sign failed", res.status, await res.text());
        cb("");
        return;
      }
      const { signature } = await res.json();
      cb(signature);
    },
    folder: "vendoro/product_images",
    multiple: true,
    sources: ["local","url","camera"],
    clientAllowedFormats: ["png","jpg","jpeg","webp"],
    maxFileSize: 5_000_000,
  }, 
  // keep this async so 'await' is valid here
  async (error, result) => {
    if (error) { console.error("Upload error", error); return; }
    if (result && result.event === "success") {
      const info = result.info;
      const r = await fetch(attachUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
          public_id: info.public_id,
          alt_text: info.original_filename || ""
        }),
        credentials: "same-origin",
      });
      if (!r.ok) {
        console.error("Attach failed", r.status, await r.text());
        return;
      }
      location.reload();
    }
  });

  const btn = document.getElementById('btn-upload');
  if (btn) btn.addEventListener('click', () => widget.open());
});
</script>

{% endblock %}