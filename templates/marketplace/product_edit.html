{% extends "base.html" %}
{% load cloudinary %}

{% block content %}
<div class="container py-3" style="max-width: 980px;">
  <h1 class="h4 mb-3">Edit Product — {{ product.title }}</h1>

  <form method="post" class="mb-4">
    {% csrf_token %}
    {{ form.as_p }}
    <button class="btn btn-primary">Save</button>
    <a class="btn btn-outline-secondary" href="{% url 'marketplace:product_detail' product.shop.slug product.slug %}">View</a>
  </form>

  <hr class="my-4"/>

  <div class="d-flex align-items-center gap-2 mb-2">
    <h2 class="h5 m-0">Images</h2>
    <button id="btn-upload" class="btn btn-outline-primary btn-sm" type="button">Add Images</button>
    <span id="upload-status" class="text-muted small" aria-live="polite"></span>
  </div>

  <div class="row g-3">
    {% for pi in product.images.all %}
      <div class="col-6 col-md-3">
        <div class="ratio ratio-1x1 rounded overflow-hidden bg-light">
          {% cloudinary pi.image width=300 height=300 crop="fill" gravity="auto" fetch_format="auto" quality="auto" class="w-100 h-100 d-block" alt=pi.alt_text %}
        </div>
        <div class="d-flex gap-2 mt-2">
          <form method="post"
                action="{% url 'marketplace:product_image_remove' product.id pi.id %}"
                class="d-inline"
                data-confirm="Remove this image from the product?"
                onsubmit="if(this.dataset.submitting==='1'||!confirm(this.getAttribute('data-confirm')||'Are you sure?')) return false; this.dataset.submitting='1'; this.querySelector('button[type=submit]')?.setAttribute('disabled','disabled')">
            {% csrf_token %}
            <button class="btn btn-sm btn-outline-secondary" type="submit">Remove</button>
          </form>
          <form method="post"
                action="{% url 'marketplace:product_image_remove' product.id pi.id %}"
                class="d-inline"
                data-confirm="Remove and permanently delete this image from Cloudinary?"
                onsubmit="if(this.dataset.submitting==='1'||!confirm(this.getAttribute('data-confirm')||'Are you sure?')) return false; this.dataset.submitting='1'; this.querySelector('button[type=submit]')?.setAttribute('disabled','disabled')">
            {% csrf_token %}
            <input type="hidden" name="purge" value="1">
            <button class="btn btn-sm btn-outline-danger" type="submit">Remove&nbsp;&amp;&nbsp;purge</button>
          </form>
        </div>
        <div class="small text-muted mt-1 text-truncate">{{ pi.alt_text|default:"" }}</div>
      </div>
{% endfor %}

  </div>
</div>

<script>
/* global cloudinary, fetch */
document.addEventListener('DOMContentLoaded', function () {
  var btn = document.getElementById('btn-upload');
  if (!btn) {
    return;
  }

  btn.type = 'button';
  btn.disabled = true;
  btn.textContent = 'Loading…';

  var CLOUD_NAME = "{{ CLOUDINARY_CLOUD_NAME|default:''|escapejs }}".trim();
  var API_KEY    = "{{ CLOUDINARY_API_KEY|default:''|escapejs }}".trim();
  var signUrl    = "{% url 'marketplace:cloudinary_sign' %}";
  var attachUrl  = "{% url 'marketplace:product_image_attach' product.id %}";

  if (!CLOUD_NAME || !API_KEY) {
    btn.textContent = 'Uploader unavailable';
    return;
  }

  function ensureCloudinaryLoaded(cb) {
    if (window.cloudinary && window.cloudinary.createUploadWidget) {
      cb();
      return;
    }
    var s = document.createElement('script');
    s.src = 'https://widget.cloudinary.com/v2.0/global/all.js';
    s.async = true;
    s.onload = cb;
    s.onerror = function () {
      btn.textContent = 'Uploader failed to load';
    };
    document.head.appendChild(s);
  }

  function getCookie(name) {
    var match = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return match ? match.pop() : '';
  }

  ensureCloudinaryLoaded(function () {
    var widget = cloudinary.createUploadWidget({
      cloudName: CLOUD_NAME,
      apiKey: API_KEY,
      folder: 'vendoro/product_images',
      multiple: true,
      sources: ['local', 'url', 'camera'],
      clientAllowedFormats: ['png', 'jpg', 'jpeg', 'webp'],
      maxFileSize: 5000000, // 5 MB
      uploadSignature: function (cb, params) {
        try {
          var url = signUrl + '?' + new URLSearchParams(params).toString();
          fetch(url, { credentials: 'same-origin' })
            .then(function (res) {
              if (!res.ok) {
                cb('');
                return null;
              }
              return res.json();
            })
            .then(function (data) {
              if (!data) {
                return;
              }
              if (data.signature) {
                cb(data.signature);
              } else {
                cb('');
              }
            })
            .catch(function () {
              cb('');
            });
        } catch (e) {
          cb('');
        }
      }
    }, function (error, result) {
      if (error) {
        return;
      }
      if (result && result.event === 'success') {
        var info = result.info;
        var payload = {
          public_id: info.public_id,
          alt_text: info.original_filename || ''
        };

        fetch(attachUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          credentials: 'same-origin',
          body: JSON.stringify(payload)
        })
          .then(function () {
            // Reload to show the new image in the grid.
            window.location.reload();
          })
          .catch(function () {
            window.location.reload();
          });
      }
    });

    btn.disabled = false;
    btn.textContent = 'Add Images';
    btn.addEventListener('click', function () {
      widget.open();
    });
  });
});
</script>

{% endblock %}