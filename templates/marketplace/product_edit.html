{% extends "base.html" %}
{% load cloudinary %}

{% block content %}
<div class="container py-3" style="max-width: 980px;">
  <h1 class="h4 mb-3">Edit Product — {{ product.title }}</h1>

  <form method="post" class="mb-4">
    {% csrf_token %}
    {{ form.as_p }}
    <button class="btn btn-primary">Save</button>
    <a class="btn btn-outline-secondary" href="{% url 'marketplace:product_detail' product.shop.slug product.slug %}">View</a>
  </form>

  <hr class="my-4"/>

  <div class="d-flex align-items-center gap-2 mb-2">
    <h2 class="h5 m-0">Images</h2>
    <button id="btn-upload" class="btn btn-outline-primary btn-sm" type="button">Add Images</button>
    <span id="upload-status" class="text-muted small" aria-live="polite"></span>
  </div>

  <div class="row g-3">
    {% for pi in product.images.all %}
      <div class="col-6 col-md-3">
        <div class="ratio ratio-1x1 rounded overflow-hidden bg-light">
          {% cloudinary pi.image width=300 height=300 crop="fill" gravity="auto" fetch_format="auto" quality="auto" class="w-100 h-100 d-block" alt=pi.alt_text %}
        </div>
        <div class="small text-muted mt-1 text-truncate">{{ pi.alt_text|default:"" }}</div>
      </div>
    {% empty %}
      <div class="col-12"><em>No images yet.</em></div>
    {% endfor %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('btn-upload');
  const statusEl = document.getElementById('upload-status');
  if (!btn) return;

  // Template vars
  const signUrl    = "{% url 'marketplace:cloudinary_sign' %}";
  const attachUrl  = "{% url 'marketplace:product_image_attach' product.id %}";
  const CLOUD_NAME = "{{ CLOUDINARY_CLOUD_NAME|default:''|escapejs }}".trim();
  const API_KEY    = "{{ CLOUDINARY_API_KEY|default:''|escapejs }}".trim();

  // If config is missing, quietly bail (button stays disabled)
  if (!CLOUD_NAME || !API_KEY) {
    if (statusEl) statusEl.textContent = "Uploader unavailable.";
    btn.disabled = true;
    return;
  }

  // Lightweight status helper (no alerts)
  const setStatus = (msg) => { if (statusEl) statusEl.textContent = msg || ""; };

  btn.type = 'button';
  btn.disabled = true;
  setStatus("Loading uploader…");

  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }

  // Lazy-load the Cloudinary widget only if needed
  function ensureCloudinaryLoaded() {
    if (window.cloudinary?.createUploadWidget) return Promise.resolve();
    return new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = 'https://widget.cloudinary.com/v2.0/global/all.js';
      s.async = true;
      s.onload  = () => window.cloudinary?.createUploadWidget ? resolve() : reject();
      s.onerror = reject;
      document.head.appendChild(s);
    });
  }

  ensureCloudinaryLoaded().then(() => {
    const widget = cloudinary.createUploadWidget({
      cloudName: CLOUD_NAME,
      apiKey: API_KEY,
      folder: "vendoro/product_images",
      multiple: true,
      sources: ["local","url","camera"],
      clientAllowedFormats: ["png","jpg","jpeg","webp"],
      maxFileSize: 5_000_000,
      uploadSignature: async (cb, paramsToSign) => {
        try {
          const res = await fetch(
            signUrl + "?" + new URLSearchParams(paramsToSign),
            { credentials: "same-origin" }
          );
          const { signature } = await res.json();
          cb(signature || "");
        } catch (_) {
          cb("");
        }
      }
    }, async (error, result) => {
      if (error || !result || result.event !== "success") return;
      setStatus("Saving…");
      try {
        const r = await fetch(attachUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          credentials: "same-origin",
          body: JSON.stringify({
            public_id: result.info.public_id,
            alt_text: result.info.original_filename || "",
          }),
        });
        if (r.ok) {
          // keep UX snappy and consistent
          location.reload();
        } else {
          setStatus("Could not save image.");
        }
      } catch {
        setStatus("Could not save image.");
      }
    });

    btn.disabled = false;
    setStatus("");
    btn.addEventListener('click', () => widget.open());
  }).catch(() => {
    setStatus("Uploader failed to load.");
  });
});
</script>

{% endblock %}